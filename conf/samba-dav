#!/bin/bash -ex

SRC=/usr/local/src
WEBROOT=/var/www/webdavcgi

dl() {
    [ "$FAB_HTTP_PROXY" ] && PROXY="--proxy $FAB_HTTP_PROXY"
    cd $2; curl -L -f -O $PROXY $1; cd -
}

dl http://downloads.sourceforge.net/project/webdavcgi/webdavcgi-latest.tar.bz2 $SRC

tar --no-same-owner -xjf $SRC/webdavcgi-*.tar.bz2 -C $(dirname $WEBROOT)
rm $SRC/webdavcgi-*.tar.bz2

mv $(dirname $WEBROOT)/webdavcgi-* $WEBROOT
mv $SRC/webdav.conf $WEBROOT

chmod a+rx $WEBROOT $WEBROOT/cgi-bin $WEBROOT/cgi-bin/webdav.pl $WEBROOT/cgi-bin/afswrapper $WEBROOT/cgi-bin/smbwrapper
chmod -R a+r $WEBROOT

echo yes | perl -MCPAN -e 'install DateTime::Format::Human::Duration'

a2enmod rewrite
a2enmod cgi
a2enmod authnz_external

